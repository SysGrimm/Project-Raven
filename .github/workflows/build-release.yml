name: Build SoulBox Will-o'-Wisp Media Center

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-components:
    runs-on: ubuntu-latest
    
    steps:
    - name: Manual repository checkout
      run: |
        echo "=== Manual Git Checkout ==="
        cd /tmp
        git clone http://192.168.176.113:3000/reaper/soulbox.git soulbox-build
        cd soulbox-build
        echo "Repository cloned successfully"
        cp -r . $GITHUB_WORKSPACE/
        cd $GITHUB_WORKSPACE
        echo "Files in workspace:"
        ls -la
      
    - name: Install build dependencies
      run: |
        echo "=== Installing Dependencies ==="
        sudo apt-get update -q
        sudo apt-get install -y --no-install-recommends \
          debootstrap \
          qemu-user-static \
          binfmt-support \
          parted \
          kpartx \
          dosfstools \
          e2fsprogs \
          wget \
          curl \
          systemd-container \
          util-linux \
          mount
        echo "Dependencies installed successfully"
    
    - name: Set up ARM64 emulation
      run: |
        echo "=== Setting up ARM64 Emulation ==="
        # Check if qemu-aarch64-static is available
        if [ -f /usr/bin/qemu-aarch64-static ]; then
            echo "qemu-aarch64-static found"
        else
            echo "ERROR: qemu-aarch64-static not found"
            exit 1
        fi
        
        # Use update-binfmts instead of manual registration
        echo "Registering ARM64 emulation via update-binfmts..."
        sudo update-binfmts --enable qemu-aarch64 || echo "Using existing registration"
        
        # Alternative: try manual registration if update-binfmts fails
        if ! sudo update-binfmts --display qemu-aarch64 >/dev/null 2>&1; then
            echo "Manual binfmt registration as fallback..."
            echo ':qemu-aarch64:M::\x7fELF\x02\x01\x01\x00\x00\x00\x00\x00\x00\x00\x00\x00\x02\x00\xb7\x00:\xff\xff\xff\xff\xff\xff\xff\x00\xff\xff\xff\xff\xff\xff\xff\xff\xfe\xff\xff\xff:/usr/bin/qemu-user-static:F' | sudo tee /proc/sys/fs/binfmt_misc/register >/dev/null 2>&1 || echo "Registration attempted"
        fi
        
        echo "ARM64 emulation setup complete - will be tested during debootstrap"
        echo "ARM64 emulation configured successfully"
        
    - name: Free up disk space
      run: |
        echo "=== Disk Space Management ==="
        df -h
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet /opt/ghc /usr/local/share/boost /var/lib/apt/lists/* 2>/dev/null || true
        echo "Disk space after cleanup:"
        df -h
    
    - name: Build SoulBox Media Center Image
      run: |
        echo "=== Building SoulBox Will-o'-Wisp Media Center ==="
        set -e
        set -x
        
        # Get version for build
        if [ -f "scripts/version-manager.sh" ]; then
            VERSION=$(./scripts/version-manager.sh auto 2>/dev/null | tail -1 || echo "v0.1.0")
        else
            VERSION="v0.1.0"
        fi
        
        echo "Building SoulBox $VERSION - Complete Media Center with Kodi & Tailscale"
        
        # Run primary image build using image modification
        ./build-soulbox-image-mod.sh --version "$VERSION" --clean
        
        # Create artifacts directory and copy result
        mkdir -p artifacts
        if [ -f "soulbox-v"*".img" ]; then
            cp soulbox-v*.img artifacts/
            cp soulbox-v*.img.sha256 artifacts/
            echo "âœ… SoulBox image created successfully!"
            ls -lh artifacts/
        else
            echo "âŒ Build failed - no image file found"
            exit 1
        fi
        
        echo "ğŸ”¥ SoulBox build complete - ready to flash and deploy! ğŸ”¥"

    - name: Upload SoulBox Image
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: soulbox-wisp-image
        path: artifacts/
        retention-days: 30

    - name: Upload Build Logs
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: build-logs
        path: |
          *.log
          build/
        retention-days: 7
        
    - name: Build Summary
      if: success()
      run: |
        echo "ğŸ”¥ SoulBox Will-o'-Wisp Media Center Build Complete! ğŸ”¥"
        echo "====================================================="
        echo ""
        echo "Image created:"
        ls -la artifacts/
        echo ""
        echo "âœ¨ Features included:"
        echo "   ğŸ¬ Kodi Media Center (auto-start with splash)"
        echo "   ğŸŒ Tailscale VPN integration"
        echo "   âš¡ Raspberry Pi 5 optimizations"
        echo "   ğŸ”§ Complete systemd service configuration"
        echo "   ğŸ” SSH enabled with default credentials"
        echo "   ğŸ  Pre-configured media directories"
        echo "   ğŸ¨ Will-o'-wisp branding and theming"
        echo ""
        echo "ğŸš€ Ready to deploy:"
        echo "   1. Download the .img file from artifacts"
        echo "   2. Flash to SD card (8GB+ recommended)"
        echo "   3. Boot on Raspberry Pi 5"
        echo "   4. First boot will complete setup automatically"
        echo ""
        echo "ğŸ“‹ Default credentials:"
        echo "   - soulbox:soulbox (recommended user)"
        echo "   - pi:soulbox (compatibility)"
        echo "   - root:soulbox (admin access)"
        echo ""
        echo "ğŸ”¥ The blue flame burns bright and awaits deployment! ğŸ”¥"

